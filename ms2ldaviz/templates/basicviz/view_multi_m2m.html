{% extends 'base.html' %}

{% load static %}



{% block title %}Multifile Motif View{% endblock %}

{% block head_block %}
	<style>
		.axis path,
		.axis line {
			fill: none;
			stroke: black;
			shape-rendering: crispEdges;
		}
		.axis text {
			font-family: sans-serif;
			font-size: 11px;
		}
	</style>
	<link rel="stylesheet" type="text/css" href="{% static "css/basicviz.css" %}">

{% endblock %}

{% block body_block %}
<h3>Motif {{motif_name}} in {{mfe.name}}</h3>

<form id="mass2motifmetadata_form" method="post" action="/basicviz/view_multi_m2m/{{mfe.id}}/{{motif_name}}/">
	{% csrf_token %}
	{% for hidden in metadata_form.hidden_fields %}
	 	{{ hidden }}
	{% endfor %}

	{% for field in metadata_form.visible_fields %}
		{{ field.errors }}
		{{ field }}
	{% endfor %}
	<input type="submit" name="submit" value="Modify metadata" />
</form>


<h4>Variance: {{alpha_variance}}</h4>
<p>Return to <a href="/basicviz/multi_alphas/{{mfe.id}}/">alpha page</a></p>
<h4>Features:</h4>

<table class="table" id="featuretable">
	<thead>
		<th>Feature</th>
		<th>Probability</th>
	</thead>
	<tbody>
	{% for feature in m2m_features %}
		<tr>
			<td>{{feature.feature.name}}</td>
			<td>{{feature.probability}}</td>
		</tr>
	{% endfor %}
	</tbody>
</table>

<hr />
<h4>Individual Mass2Motifs</h4>

<table class="table" id = "m2mtable">
	<thead>
		<th>Individual MS2LDA</th><th>Motif</th><th>Annotation</th><th>Alpha</th><th>Degree</th>
	</thead>
	<bdody>
		{% for row in individual_m2m %}
		<tr>
			<td>{{row.0.name}}</td>
			<td><a href="/basicviz/view_parents/{{row.1.id}}/">{{row.1.name}}</a></td>
			<td>{{row.1.annotation}}</td>
			<td>{{row.2.value}}</td>
			<td>{{row.3}}</td>
		</tr>
		{% endfor %}
	</bdody>
</table>

<div class="row">
	<div class="col-md-6">
		<div id="barplot">
			<h3>Alphas</h3>
		</div>
		<div id="degreeplot">
			<h3>Degrees</h3>
		</div>
			<div id="heatmap">
		</div>
	</div>
	<div class="col-md-6">
		<div id="scatter">
			<h3>Parent ions</h3>
		</div>	
	</div>
</div>




{% endblock %}



{% block js_block %}

<script src="{% static 'js/dataTables/jquery.dataTables.min.js' %}"></script>
<script src="{% static 'js/dataTables/dataTables.bootstrap.min.js' %}"></script>

<script src="{% static 'js/dataTables/dataTables.buttons.min.js' %}"></script>
<script src="{% static 'js/dataTables/buttons.html5.min.js' %}"></script>

<script type='text/javascript' src="{% static 'js/d3.v3.min.js' %}"></script>
<script type='text/javascript' src="{% static 'js/basicviz-barplot.js' %}"></script>


<link rel="stylesheet" href="{% static 'js/dataTables/dataTables.bootstrap.min.css' %}" type="text/css">
<link rel="stylesheet" href="{% static 'js/dataTables/buttons.dataTables.min.css' %}" type="text/css">


<script type="text/javascript">
$(document).ready(function() {
	$('#featuretable').DataTable({
		dom: 'Bfrtip',
		buttons: [
        'csv',
        ],
        "order": [[ 1, "desc" ]],
    });
    $('#m2mtable').DataTable({
    	dom: 'Bfrtrip',
    	buttons: [
    		'csv',
    	],
    	"order": [[2,"desc"]],
    });
   
});


bar_plot('/basicviz/get_alphas/{{mfe.id}}/{{motif_name}}/','barplot')
bar_plot('/basicviz/get_degrees/{{mfe.id}}/{{motif_name}}/','degreeplot')


scatter_data = {{doc_table|safe}}
individual_names = {{individual_names|safe}}

var plot_height = 500
var plot_width = 500


scatter_svg = d3.select('#scatter').append('svg')
	.attr('width',plot_width)
	.attr('height',plot_height);

min_mz = d3.min(scatter_data,function(d) {return d[1];}) - 20
max_mz = d3.max(scatter_data,function(d) {return d[1];}) + 20
min_rt = d3.min(scatter_data,function(d) {return d[0];}) - 20
max_rt = d3.max(scatter_data,function(d) {return d[0];}) + 20
max_ind = d3.max(scatter_data,function(d) {return d[2];})

var ver_margin = 50
var hor_margin = 50
var xScale = d3.scale.linear()
xScale.domain([min_rt, max_rt])
xScale.range([ hor_margin,plot_width-hor_margin])
var yScale = d3.scale.linear()
yScale.domain([min_mz,max_mz])
yScale.range([plot_height-ver_margin,ver_margin])


var xAxis = d3.svg.axis()
    .scale(xScale)
    .orient("bottom");

scatter_svg.append("g")
    .attr("class", "axis")
    .attr("transform", "translate(0," + yScale(min_mz) + ")")
    .attr('stroke-width',1)
    .attr('id','xax')
    .call(xAxis);


var yAxis = d3.svg.axis()
    .scale(yScale)
    .orient("left");

scatter_svg.append("g")
	.attr('id','yax')
    .attr("class","axis")
    .attr('stroke-width',1)
    .attr("transform","translate(" + xScale(min_rt) + ",0)")
    .call(yAxis);


scatter_svg.append('text').attr('x',xScale(0.5*(max_rt + min_rt)))
						  .attr('y',yScale(min_mz) + 50)
						  .text('rt');


scatter_svg.append('text').attr('x',xScale(min_rt) - 50)
						  .attr('y',yScale(0.5*(min_mz+max_mz)))
						  .text('mz');

var circles = scatter_svg.selectAll("circle")
				.data(scatter_data)
				.enter()
				.append("circle")

var individual_name = scatter_svg.append('text')
									.attr('x',xScale(min_rt)+50)
									.attr('y',yScale(max_mz)-20)

var colorscale = d3.scale.linear().domain([0,max_ind]).range(["red","blue"])
circles.attr('cx',function(d) {return xScale(d[0]);})
	    .attr('cy',function(d) {return yScale(d[1]);})
		.attr('r',function(d) {return Math.ceil(5*d[3]);})
		.attr('fill','#666666')
		.attr('class',function(d) {return "ind_" + d[2];})
		.on('mouseover',function(d) {
			scatter_highlight(d[2]);
				// scatter_svg.selectAll('.ind_'+d[2])
				// 	.transition()
				// 	.duration(250)
				// 	.attr('r',function(d) {return Math.ceil(40*d[3]);})
				// 	.attr('fill',function(d) {return colorscale(d[2]);});
				// individual_name.text(individual_names[d[2]]);
			})
		.on('mouseout',function(d) {
			scatter_unhighlight(d[2])
		});

function scatter_highlight(n) {
	scatter_svg.selectAll('.ind_'+n)
					.transition()
					.duration(250)
					.attr('r',function(d) {return Math.ceil(40*d[3]);})
					.attr('fill',function(d) {return colorscale(d[2]);});
				individual_name.text(individual_names[n]);
}	
function scatter_unhighlight(n) {
	scatter_svg.selectAll('.ind_'+n)
				.transition()
				.duration(250)
				.attr('fill','#666666')
				.attr('r',function(d) {return Math.ceil(5*d[3]);})
			individual_name.text("");
}

// var a= scatter_svg.selectAll('.ind_1').attr('r',20);
// console.log(a.length)
// console.log(a)
var heatmap_height = 400
var heatmap_width = 600

var heatmap_hor_margin = 70
var heatmap_ver_margin = 30
var heatmap_svg = d3.select('#heatmap').append('svg')
	.attr('width',heatmap_width)
	.attr('height',heatmap_height);

heatmap_data = {{intensity_table|safe}}

console.log(heatmap_data.length)

var n_rows = heatmap_data.length
var n_cols = individual_names.length

var heatmap_xScale = d3.scale.linear()
heatmap_xScale.domain([0,n_cols])
heatmap_xScale.range([ heatmap_hor_margin,heatmap_width-heatmap_hor_margin])
var heatmap_yScale = d3.scale.linear()
heatmap_yScale.domain([0,n_rows])
heatmap_yScale.range([heatmap_ver_margin,heatmap_height - heatmap_ver_margin])

var box_width = (heatmap_width - 2*heatmap_hor_margin)/n_cols
var box_height = Math.min((heatmap_height - 2*heatmap_ver_margin)/n_rows,20)


max_val = 0.0
min_val = 1e10


for (var i = 0; i < heatmap_data.length; i++) {
	for (var j=0 ; j<heatmap_data[i].length; j++) {
		if(heatmap_data[i][j] != 0) {
			if(heatmap_data[i][j] < min_val) {
				min_val = heatmap_data[i][j];
			}
			if(heatmap_data[i][j] > max_val) {
				max_val = heatmap_data[i][j];
			}
		}
	}
}

var heatmap_colorscape = d3.scale.linear()
							.domain([min_val,max_val]).range(["blue","yellow"]);


for (var i = 0; i < heatmap_data.length; i++) {
	for (var j=0 ; j<heatmap_data[i].length; j++) {
		if(heatmap_data[i][j] != 0) {
			heatmap_svg.append("rect")
				.attr('x',heatmap_xScale(j))
				.attr('y',i*box_height)
				.attr('width',box_width)
				.attr('height',box_height)
				.attr('stroke','#000000')
				.attr('fill',heatmap_colorscape(heatmap_data[i][j]));
		}
	}
}


</script>
{% endblock %}


