{% extends 'base.html' %}

{% load static %}



{% block title %}Multifile Motif View{% endblock %}

{% block head_block %}
	<style>
		.axis path,
		.axis line {
			fill: none;
			stroke: black;
			shape-rendering: crispEdges;
		}
		.axis text {
			font-family: sans-serif;
			font-size: 11px;
		}
	</style>
	<link rel="stylesheet" type="text/css" href="{% static "css/basicviz.css" %}">

{% endblock %}

{% block body_block %}
<h3>Motif {{motif_name}} in {{mfe.name}}</h3>

<form id="mass2motifmetadata_form" method="post" action="/basicviz/view_multi_m2m/{{mfe.id}}/{{motif_name}}/">
	{% csrf_token %}
	{% for hidden in metadata_form.hidden_fields %}
	 	{{ hidden }}
	{% endfor %}

	{% for field in metadata_form.visible_fields %}
		{{ field.errors }}
		{{ field }}
	{% endfor %}
	<input type="submit" name="submit" value="Modify metadata" />
</form>


<h4>Variance: {{alpha_variance}}</h4>
<p>Return to <a href="/basicviz/multi_alphas/{{mfe.id}}/">alpha page</a></p>
<h4>Features:</h4>

<table class="table" id="featuretable">
	<thead>
		<th>Feature</th>
		<th>Probability</th>
	</thead>
	<tbody>
	{% for feature in m2m_features %}
		<tr>
			<td>{{feature.feature.name}}</td>
			<td>{{feature.probability}}</td>
		</tr>
	{% endfor %}
	</tbody>
</table>

<hr />
<h4>Individual Mass2Motifs</h4>

<table class="table" id = "m2mtable">
	<thead>
		<th>Individual MS2LDA</th><th>Motif</th><th>Annotation</th><th>Alpha</th><th>Degree</th>
	</thead>
	<bdody>
		{% for row in individual_m2m %}
		<tr>
			<td>{{row.0.name}}</td>
			<td><a href="/basicviz/view_parents/{{row.1.id}}/">{{row.1.name}}</a></td>
			<td>{{row.1.annotation}}</td>
			<td>{{row.2.value}}</td>
			<td>{{row.3}}</td>
		</tr>
		{% endfor %}
	</bdody>
</table>


<div id="barplot">
<h3>Alphas</h3>
</div>
<div id="degreeplot">
<h3>Degrees</h3>
</div>


<div id="scatter">
<h3>Parent ions</h3>
</div>	
{% endblock %}



{% block js_block %}

<script src="{% static 'js/dataTables/jquery.dataTables.min.js' %}"></script>
<script src="{% static 'js/dataTables/dataTables.bootstrap.min.js' %}"></script>

<script src="{% static 'js/dataTables/dataTables.buttons.min.js' %}"></script>
<script src="{% static 'js/dataTables/buttons.html5.min.js' %}"></script>

<script type='text/javascript' src="{% static 'js/d3.v3.min.js' %}"></script>
<script type='text/javascript' src="{% static 'js/basicviz-barplot.js' %}"></script>


<link rel="stylesheet" href="{% static 'js/dataTables/dataTables.bootstrap.min.css' %}" type="text/css">
<link rel="stylesheet" href="{% static 'js/dataTables/buttons.dataTables.min.css' %}" type="text/css">


<script type="text/javascript">
$(document).ready(function() {
	$('#featuretable').DataTable({
		dom: 'Bfrtip',
		buttons: [
        'csv',
        ],
        "order": [[ 1, "desc" ]],
    });
    $('#m2mtable').DataTable({
    	dom: 'Bfrtrip',
    	buttons: [
    		'csv',
    	],
    	"order": [[2,"desc"]],
    });
   
});


bar_plot('/basicviz/get_alphas/{{mfe.id}}/{{motif_name}}/','barplot')
bar_plot('/basicviz/get_degrees/{{mfe.id}}/{{motif_name}}/','degreeplot')


scatter_data = {{doc_table|safe}}

scatter_svg = d3.select('#scatter').append('svg')
	.attr('width',700)
	.attr('height',700);

min_mz = d3.min(scatter_data,function(d) {return d[0];}) - 20
max_mz = d3.max(scatter_data,function(d) {return d[0];}) + 20
min_rt = d3.min(scatter_data,function(d) {return d[1];}) - 20
max_rt = d3.max(scatter_data,function(d) {return d[1];}) + 20
max_ind = d3.max(scatter_data,function(d) {return d[2];})

var plot_height = 700
var plot_width = 700
var ver_margin = 50
var hor_margin = 50
var xScale = d3.scale.linear()
xScale.domain([min_mz, max_mz])
xScale.range([ hor_margin,plot_width-hor_margin])
var yScale = d3.scale.linear()
yScale.domain([min_rt,max_rt])
yScale.range([plot_height-ver_margin,ver_margin])


var xAxis = d3.svg.axis()
    .scale(xScale)
    .orient("bottom");

scatter_svg.append("g")
    .attr("class", "axis")
    .attr("transform", "translate(0," + yScale(min_rt) + ")")
    .attr('stroke-width',1)
    .attr('id','xax')
    .call(xAxis);


var yAxis = d3.svg.axis()
    .scale(yScale)
    .orient("left");

scatter_svg.append("g")
	.attr('id','yax')
    .attr("class","axis")
    .attr('stroke-width',1)
    .attr("transform","translate(" + xScale(min_mz) + ",0)")
    .call(yAxis);


scatter_svg.append('text').attr('x',xScale(0.5*(max_mz + min_mz)))
						  .attr('y',yScale(min_rt) + 50)
						  .text('mz');


scatter_svg.append('text').attr('x',xScale(min_mz) - 50)
						  .attr('y',yScale(0.5*(min_rt+max_rt)))
						  .text('rt');

var circles = scatter_svg.selectAll("circle")
				.data(scatter_data)
				.enter()
				.append("circle")

var colorscale = d3.scale.linear().domain([0,max_ind]).range(["red","blue"])
circles.attr('cx',function(d) {return xScale(d[0]);})
	    .attr('cy',function(d) {return yScale(d[1]);})
		.attr('r',function(d) {return Math.ceil(5*d[3]);})
		.attr('fill',function(d) {console.log(colorscale(d[2]));return colorscale(d[2])});

</script>
{% endblock %}


