{% extends 'base.html' %}

{% load static %}

{% block head_block %}
{% endblock %}

{% block body_block %}

	<h3>Add a new experiment</h3>
    <p>
        You can choose either to decompose your spectra in a completely
        unsupervised manner (experiment type <strong>LDA</strong>) or with respect to
        existing Mass2Motifs that we have annotated
        (experiment type <strong>Decomposition</strong>). Please scroll down for more detailed instructions.
    </p>
    <p>
        If an MS1 CSV file is provided, it will be used to seed the precursor peaks during the extraction of fragmentation spectra.
        The uploaded MS2 file has to be in mzML format for now.
    </p>

    <form id="experiment_form" method="post" action="/uploads/create_experiment/" enctype="multipart/form-data">
        {% csrf_token %}
        {% for hidden in experiment_form.hidden_fields %}
            {{ hidden }}
        {% endfor %}

        {% for field in experiment_form.visible_fields %}
            <p>{{ field.errors }}</p>
            <p>  {{field.label}} {% if field.field.required %} * {% endif %} {{ field }}</p>
        {% endfor %}
        <input type="submit" name="submit" value="Submit Your Experiment" class="btn btn-primary" />
    </form>
    <hr />
    <h5>MS1 Peaklist File Format</h5>
    <p>
        <small>
            <a href="{% static "txt/example_peaklist.csv" %}">Download an example here</a>.
        </small>
    </p>
    <p>
        <small>
            The required file format for the MS1 peak list is as follows:
        </small>
    </p>
    <p>
        <small>
            A .CSV file with header line:
        </small>
    </p>
    <blockquote>
        ("..., mass, RT, samplename_1, samplename_2,..."), delimiter: '.
    </blockquote>
    <p>
        <small>
            The <strong>mass</strong> column must have the column header of either 'mass' or 'mz' (case-insensitive).
            Retention time is assumed to be the column immediately after mass, and should be in seconds.
            Any columns before <strong>mass</strong> (e.g. containing peak IDs from other software) will be ignored.
        </small>
    </p>
    <p>
        <small>
            All columns after retention time will be interpreted as MS1 intensities, with one column per sample.
            In the .CSV file, missing data can be stored as empty, e.g.
        </small>
    </p>
    <blockquote>
        123.45,,567.89
    </blockquote>
    <p>
        <small>
            or NA, e.g.
        </small>
    </p>
    <blockquote>
        123.45,NA,567.89
    </blockquote>
    <p>
        <small>
            Any intensities that are negative values, cannot be interpreted as a float, or are empty will be ignored
            and not be stored for further analysis.
        </small>
    </p>
{% endblock %}

{% block js_block %}
    <script type='text/javascript'>

        $('#id_experiment_type').on('change', function() {
            // var a = $(this).val();

            // if (a === '0') { // ms2lda
            //     $('#id_decomposition_source').parent().show();
            //     $('#id_K').parent().show();
            //     $('#id_decompose_from').parent().hide();

            // } else { // decomposition
            //     $('#id_decomposition_source').parent().hide();
            //     $('#id_K').parent().hide();
            //     $('#id_decompose_from').parent().show();
            // }

            // Use toggle function
            $('#id_decomposition_source').parent().toggle();
            $('#id_K').parent().toggle();
            $('#id_decompose_from').parent().toggle();

        });

        $('#id_experiment_ms2_format').on('change', function() {
            // reset 'filter ms1 duplicate' when choosing msp format input
            if ($(this).val() == '1'){
                $('#id_filter_duplicates').prop('checked', false);
                $('#id_duplicate_filter_mz_tol').parent().hide();
                $('#id_duplicate_filter_rt_tol').parent().hide();
            }

            $('#id_csv_file').parent().toggle();
            $('#id_isolation_window').parent().toggle();
            $('#id_mz_tol').parent().toggle();
            $('#id_rt_tol').parent().toggle();
            $('#id_min_ms1_rt').parent().toggle();
            $('#id_max_ms1_rt').parent().toggle();
            $('#id_filter_duplicates').parent().toggle();

        });



        // Only show following two lines when ms1 duplicate checkbox is checked
        $('#id_filter_duplicates').click(function(){
            if($(this).is(":checked")){
                $('#id_duplicate_filter_mz_tol').parent().show();
                $('#id_duplicate_filter_rt_tol').parent().show();
            } else{
                $('#id_duplicate_filter_mz_tol').parent().hide();
                $('#id_duplicate_filter_rt_tol').parent().hide();
            }
        });

        // initial state
        $('#id_decompose_from').parent().hide();
        $('#id_duplicate_filter_mz_tol').parent().hide();
        $('#id_duplicate_filter_rt_tol').parent().hide();

    </script>
{% endblock %}